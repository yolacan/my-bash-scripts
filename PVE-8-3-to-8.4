#!/bin/bash

echo "ğŸš€ Proxmox VE 8.3 â†’ 8.4 GÃ¼ncelleme BaÅŸlatÄ±lÄ±yor..."

# 1. GÃ¼ncelleme listelerini yenile
echo "ğŸ“¦ APT kaynaklarÄ± gÃ¼ncelleniyor..."
apt update

# 2. Var olan sistemi gÃ¼ncelle
echo "ğŸ› ï¸ Var olan sistem yÃ¼kseltiliyor (dist-upgrade)..."
apt -y dist-upgrade

# 3. Enterprise deposu varsa pasifleÅŸtir
echo "ğŸ“ Enterprise deposu kontrol ediliyor..."
if grep -q '^deb https://enterprise.proxmox.com' /etc/apt/sources.list.d/pve-enterprise.list 2>/dev/null; then
  echo "ğŸ”§ Enterprise deposu devre dÄ±ÅŸÄ± bÄ±rakÄ±lÄ±yor..."
  sed -i 's|^deb https://enterprise.proxmox.com|# deb https://enterprise.proxmox.com|' /etc/apt/sources.list.d/pve-enterprise.list
else
  echo "âœ… Enterprise deposu zaten devre dÄ±ÅŸÄ±."
fi

# 4. No-subscription deposunu ekle
echo "ğŸ“¥ No-subscription deposu ekleniyor..."
echo "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription" > /etc/apt/sources.list.d/pve-no-subscription.list

# 5. APT listelerini tekrar gÃ¼ncelle
echo "ğŸ”„ Paket listeleri tekrar gÃ¼ncelleniyor..."
apt update

# 6. Proxmox VE tam gÃ¼ncelleme
echo "â¬†ï¸ Proxmox VE 8.4 sÃ¼rÃ¼mÃ¼ne yÃ¼kseltiliyor..."
apt -y full-upgrade

# 7. TamamlandÄ±ktan sonra yeniden baÅŸlatma teklifi
echo "âœ… GÃ¼ncelleme tamamlandÄ±!"
read -p "â™»ï¸ Åimdi sistemi yeniden baÅŸlatmak ister misiniz? (e/h): " reboot_answer
if [[ "$reboot_answer" == "e" || "$reboot_answer" == "E" ]]; then
  echo "ğŸ” Sistem yeniden baÅŸlatÄ±lÄ±yor..."
  reboot
else
  echo "â³ Yeniden baÅŸlatma iptal edildi. LÃ¼tfen manuel olarak reboot yapÄ±n."
fi
